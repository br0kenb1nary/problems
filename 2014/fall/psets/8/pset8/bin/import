#!/usr/bin/env php
<?php

    // requirements
    require("../includes/config.php");

    // ensure proper usage
    if ($argc !== 2)
    {
        print("Usage: import /path/to/txt\n");
        exit(1);
    }

    //
    if (!file_exists($argv[1]))
    {
        print("File does not exist\n");
        exit(1);
    }

    //
    if (!is_readable($argv[1]))
    {
        print("File is not readable\n");
        exit(1);
    }

    // open file
    $handle = fopen($argv[1], "r");
    if ($handle === false)
    {
        exit(1);
    }

    // iterate over file's rows
    while ($row = fgetcsv($handle, 0, "\t"))
    {
        // insert country into database
        if (query("INSERT INTO geonames (country_code, postal_code, place_name, admin_name1, admin_code1, admin_name2, admin_code2, admin_name3, admin_code3, latitude, longitude, accuracy) VALUES(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)",
            $row[0], $row[1], $row[2], $row[3], $row[4], $row[5], $row[6], $row[7], $row[8], $row[9], $row[10], $row[11]) === false)
        {
            // TODO: determine why
            printf("Could not insert into database.\n");
            print_r($row);
            printf("\n");
        }
    }
    fclose($handle);

    // success
    exit(0);

?>
